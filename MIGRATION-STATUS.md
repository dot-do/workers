# Workers Migration Status

**Last Updated**: 2025-10-04
**Migration Target**: mdxe (zero-config MDX development environment)

## Overview

This document tracks the migration of workers from traditional structure (src/index.ts + wrangler.jsonc) to unified .mdx format using mdxe.

## Migration Guidelines

### ‚úÖ Should Be Migrated to .mdx

Workers that meet ALL of these criteria:
- Simple, focused functionality (< 500 LOC)
- Minimal external dependencies
- Good documentation value (benefit from combining docs + code)
- Not part of critical infrastructure (test first before migrating critical services)

### ‚ùå Should Remain as Traditional Workers

Workers that have ANY of these characteristics:
- Complex business logic (> 500 LOC)
- Many external dependencies
- Part of critical infrastructure (8 core services: gateway, db, auth, schedule, webhooks, email, mcp, queue)
- Already have extensive test suites
- Need to be migrated LAST (after full validation)

## Phase 1: Testing with Less Critical Workers (In Progress)

**Goal**: Validate mdxe/wrangler integration with 5-7 simple workers

**Status**: 3/7 complete (43%)

### ‚úÖ Migrated to .mdx (3 workers)

1. **markdown.mdx** ‚úÖ - URL-to-markdown converter using Workers AI
   - Original: `workers/markdown/worker.ts` (~36 LOC)
   - Migrated: `workers/markdown.mdx` (~200 LOC with docs)
   - Build: ‚úÖ Success
   - Deploy: ‚è≥ Pending test

2. **ast.mdx** ‚úÖ - MDX/Markdown AST parser with code block extraction
   - Original: `workers/ast/worker.ts` (~215 LOC)
   - Migrated: `workers/ast.mdx` (~380 LOC with docs)
   - Build: ‚úÖ Success
   - Dependencies: yaml, mdast-util-from-markdown, acorn, acorn-jsx
   - Deploy: ‚è≥ Pending test

3. **utils.mdx** ‚úÖ - ID conversion (ULID ‚Üî Sqid) and markdown utilities
   - Original: `workers/utils/worker.ts` + utils modules (~90 LOC)
   - Migrated: `workers/utils.mdx` (~320 LOC with docs)
   - Build: ‚úÖ Success
   - Dependencies: ulid, sqids
   - Deploy: ‚è≥ Pending test

### üîß Build Script Bug Fixes

**Issue 1**: AI binding not copied from frontmatter to wrangler.jsonc

**Fix**: Added AI binding support to `scripts/build-mdx-worker.ts` (line 110)

```typescript
if (frontmatter.ai) config.ai = frontmatter.ai
```

**Issue 2**: Build config not copied from frontmatter to wrangler.jsonc

**Fix**: Added build config support to `scripts/build-mdx-worker.ts` (line 111)

```typescript
if (frontmatter.build) config.build = frontmatter.build
```

**Result**: Both AI binding and build config now correctly extracted from frontmatter

### ‚è≥ Pending Migration (4 workers)

4. **routes.mdx** - Route generation/analysis (‚ö†Ô∏è Complex - uses Workers Assets)
5. **generate.mdx** - Code generation utilities (‚ö†Ô∏è Complex - AI streaming, Hono, pipelines)
6. **docs.mdx** - Documentation generation
7. **mdx.mdx** - MDX processing worker itself

## Phase 2: Domain Workers (Pending)

**Goal**: Migrate domain-specific workers after Phase 1 validation

**Candidates** (8-10 workers):
- blog-stream
- podcast
- numerics
- voice
- admin
- api
- app
- site

## Phase 3: Core Services (Requires Explicit Approval)

**‚ö†Ô∏è DO NOT MIGRATE WITHOUT FULL VALIDATION**

These critical services should only be migrated after:
- ‚úÖ Phase 1 complete (5-7 workers successfully migrated)
- ‚úÖ Phase 2 complete (8-10 domain workers successfully migrated)
- ‚úÖ All build/deploy issues resolved
- ‚úÖ Explicit approval from project owner

**Core Services** (8 workers):
1. **gateway** - API gateway (1,349 LOC, 30+ tests)
2. **db** - Database RPC service (1,909 LOC, 16 tests)
3. **auth** - Authentication service (2,669 LOC, basic tests)
4. **schedule** - Cron jobs (1,925 LOC, 39 tests)
5. **webhooks** - External webhooks (2,114 LOC, 10 tests)
6. **email** - Transactional emails
7. **mcp** - Model Context Protocol server
8. **queue** - Message queue processing

## Migration Pattern

### Traditional Structure ‚Üí .mdx Transformation

**Original structure**:
```
workers/markdown/
‚îú‚îÄ‚îÄ worker.ts              # Implementation
‚îú‚îÄ‚îÄ wrangler.jsonc         # Config
‚îî‚îÄ‚îÄ package.json           # Dependencies
```

**Migrated structure**:
```
workers/
‚îú‚îÄ‚îÄ markdown.mdx           # All-in-one: config + code + docs
‚îî‚îÄ‚îÄ markdown/              # Generated by build script
    ‚îú‚îÄ‚îÄ wrangler.jsonc     # Extracted from frontmatter
    ‚îú‚îÄ‚îÄ src/
    ‚îÇ   ‚îî‚îÄ‚îÄ index.ts       # Extracted from code blocks
    ‚îî‚îÄ‚îÄ README.md          # Extracted from markdown
```

**Key Transformations**:

1. **Wrangler config** ‚Üí YAML frontmatter:
```mdx
---
$type: Worker
$id: markdown
name: markdown
main: src/index.ts
compatibility_date: "2025-07-08"
ai:
  binding: ai
routes:
  - pattern: markdown.fetch.do/*
    zone_name: fetch.do
---
```

2. **Implementation** ‚Üí TypeScript code block:
```mdx
## Implementation

\```typescript
import { env, WorkerEntrypoint } from 'cloudflare:workers'

export default class extends WorkerEntrypoint {
  async fetch(request: Request) {
    // Implementation...
  }
}
\```
```

3. **Documentation** ‚Üí Markdown sections:
```mdx
# Markdown Converter Worker

A Cloudflare Worker that fetches content from URLs and converts it to markdown.

## Features
- ‚úÖ URL Fetching
- ‚úÖ AI Conversion
...
```

## Benefits of .mdx Format

1. **Single Source of Truth** - Config, code, and docs in one file
2. **Zero Configuration** - Works immediately with mdxe
3. **Better Documentation** - Markdown sections explain purpose and usage
4. **Version Control Friendly** - One file = one worker
5. **Easy to Review** - See everything at once

## Testing

### Build Testing

```bash
# Build single .mdx worker
pnpm build-mdx markdown.mdx

# Build all .mdx workers
pnpm build-mdx:all

# Verify generated files
ls -la markdown/
```

### Deployment Testing

```bash
# Deploy to Cloudflare
cd markdown && wrangler deploy

# Test endpoint
curl https://markdown.fetch.do/example.com
```

## Lessons Learned

### Phase 1 Findings

1. **Build Script Issues**:
   - ‚ùå AI binding was not being extracted from frontmatter (Issue #1)
   - ‚úÖ Fixed by adding `if (frontmatter.ai) config.ai = frontmatter.ai`
   - ‚ùå Build config was not being extracted from frontmatter (Issue #2)
   - ‚úÖ Fixed by adding `if (frontmatter.build) config.build = frontmatter.build`
   - ‚ö†Ô∏è May need to add support for other bindings (Durable Objects, Analytics Engine, placement, pipelines, rules, etc.)

2. **mdxe/wrangler Integration**:
   - ‚úÖ Build process works smoothly for all 3 test workers
   - ‚úÖ Generated files match traditional structure exactly
   - ‚úÖ Dependencies (yaml, acorn, ulid, sqids) work correctly
   - ‚è≥ Deployment testing pending

3. **Documentation Value**:
   - ‚úÖ Combining docs with code significantly improves maintainability
   - ‚úÖ Markdown sections make workers self-documenting
   - ‚úÖ Frontmatter provides clear overview of dependencies and configuration
   - ‚úÖ Code blocks preserve implementation exactly as-is
   - ‚úÖ Generated README.md is comprehensive and useful

4. **Worker Complexity Assessment**:
   - ‚úÖ Simple workers (< 50 LOC) migrate easily: markdown
   - ‚úÖ Medium workers (100-250 LOC) migrate well: ast, utils
   - ‚ö†Ô∏è Complex workers (> 250 LOC, many bindings) need careful review: routes, generate
   - ‚ö†Ô∏è Workers with special features (Workers Assets, pipelines, rules) may need extra frontmatter support

5. **Migration Speed**:
   - ‚è±Ô∏è ~10-15 minutes per simple worker (including documentation)
   - ‚è±Ô∏è ~20-30 minutes per medium worker
   - ‚è±Ô∏è Build + verify takes < 30 seconds per worker
   - üí° Can migrate 3-4 simple workers per hour

## Next Steps

1. ‚úÖ Fix build script AI binding bug
2. ‚úÖ Fix build script build config bug
3. ‚úÖ Create markdown.mdx and test build
4. ‚úÖ Migrate ast.mdx (second test worker)
5. ‚úÖ Migrate utils.mdx (third test worker)
6. ‚úÖ Document findings in MIGRATION-STATUS.md
7. ‚è≥ Test deployment of migrated workers
8. ‚è≥ Migrate remaining Phase 1 workers (routes, generate, docs, mdx)
9. ‚è≥ Add frontmatter support for missing bindings (placement, pipelines, rules)
10. ‚è≥ Update workers/CLAUDE.md with mdxe guidelines
11. ‚è≥ Commit Phase 1 progress

## Related Documentation

- [scripts/MIGRATION-STATUS.md](../scripts/MIGRATION-STATUS.md) - Scripts migration tracking
- [workers/CLAUDE.md](./CLAUDE.md) - Workers architecture and development guidelines
- [mdx/CLAUDE.md](../mdx/CLAUDE.md) - MDX ecosystem tooling
- [root CLAUDE.md](../CLAUDE.md) - Repository guidelines
