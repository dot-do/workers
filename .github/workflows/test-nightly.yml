name: Nightly Tests

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8.15.2'

jobs:
  full-test-suite:
    name: Full Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run all tests
        run: pnpm test:all
        env:
          NODE_ENV: test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-test-results
          path: |
            coverage/
            tests/integration/coverage/

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm playwright install --with-deps

      - name: Run E2E tests
        run: pnpm test:e2e
        env:
          NODE_ENV: test

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            playwright-report/
            test-results/

  performance-tests:
    name: Performance Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run performance tests
        run: |
          cd tests/integration
          pnpm vitest run performance.test.ts
        env:
          NODE_ENV: test

      - name: Check for regressions
        run: |
          # Compare with baseline performance metrics
          echo "Checking for performance regressions..."
          # TODO: Implement actual regression detection

      - name: Upload performance results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-test-results
          path: tests/integration/coverage/

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        run: pnpm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for outdated dependencies
        run: pnpm outdated
        continue-on-error: true

  report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [full-test-suite, e2e-tests, performance-tests, security-scan]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate summary report
        run: |
          cat << EOF > nightly-report.md
          # Nightly Test Report - $(date +%Y-%m-%d)

          ## Test Results

          - Full Test Suite: ${{ needs.full-test-suite.result }}
          - E2E Tests: ${{ needs.e2e-tests.result }}
          - Performance Tests: ${{ needs.performance-tests.result }}
          - Security Scan: ${{ needs.security-scan.result }}

          ## Details

          View the full results in the Actions tab: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          EOF

          cat nightly-report.md

      - name: Create issue on failure
        if: |
          needs.full-test-suite.result == 'failure' ||
          needs.e2e-tests.result == 'failure' ||
          needs.performance-tests.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Nightly Test Failure - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            # Nightly Test Failure Report

            One or more nightly tests failed. Please investigate.

            ## Failed Jobs

            - Full Test Suite: ${{ needs.full-test-suite.result }}
            - E2E Tests: ${{ needs.e2e-tests.result }}
            - Performance Tests: ${{ needs.performance-tests.result }}

            ## Action Run

            [View full run details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ## Next Steps

            1. Review the test logs above
            2. Identify root cause of failures
            3. Create fix PRs as needed
            4. Re-run tests to verify fixes

            cc: @${{ github.repository_owner }}
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['test-failure', 'nightly', 'automated']
            });
