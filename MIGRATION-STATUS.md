# Workers Migration Status

**Last Updated**: 2025-10-04
**Migration Target**: mdxe (zero-config MDX development environment)

## Overview

This document tracks the migration of workers from traditional structure (src/index.ts + wrangler.jsonc) to unified .mdx format using mdxe.

## Migration Guidelines

### ‚úÖ Should Be Migrated to .mdx

Workers that meet ALL of these criteria:
- Simple, focused functionality (< 500 LOC)
- Minimal external dependencies
- Good documentation value (benefit from combining docs + code)
- Not part of critical infrastructure (test first before migrating critical services)

### ‚ùå Should Remain as Traditional Workers

Workers that have ANY of these characteristics:
- Complex business logic (> 500 LOC)
- Many external dependencies
- Part of critical infrastructure (8 core services: gateway, db, auth, schedule, webhooks, email, mcp, queue)
- Already have extensive test suites
- Need to be migrated LAST (after full validation)

## Phase 1: Testing with Less Critical Workers (In Progress)

**Goal**: Validate mdxe/wrangler integration with 5-7 simple workers

**Status**: 1/7 complete

### ‚úÖ Migrated to .mdx (1 worker)

1. **markdown.mdx** ‚úÖ - URL-to-markdown converter using Workers AI
   - Original: `workers/markdown/worker.ts` (~36 LOC)
   - Migrated: `workers/markdown.mdx` (~200 LOC with docs)
   - Build: ‚úÖ Success
   - Deploy: ‚è≥ Pending test

### üîß Build Script Bug Fixes

**Issue**: AI binding not copied from frontmatter to wrangler.jsonc

**Fix**: Added AI binding support to `scripts/build-mdx-worker.ts` (line 110)

```typescript
if (frontmatter.ai) config.ai = frontmatter.ai
```

**Result**: AI binding now correctly extracted and included in generated wrangler.jsonc

### ‚è≥ Pending Migration (6 workers)

2. **ast.mdx** - AST parsing/manipulation
3. **routes.mdx** - Route generation/analysis
4. **generate.mdx** - Code generation utilities
5. **docs.mdx** - Documentation generation
6. **utils.mdx** - General utilities
7. **mdx.mdx** - MDX processing worker itself

## Phase 2: Domain Workers (Pending)

**Goal**: Migrate domain-specific workers after Phase 1 validation

**Candidates** (8-10 workers):
- blog-stream
- podcast
- numerics
- voice
- admin
- api
- app
- site

## Phase 3: Core Services (Requires Explicit Approval)

**‚ö†Ô∏è DO NOT MIGRATE WITHOUT FULL VALIDATION**

These critical services should only be migrated after:
- ‚úÖ Phase 1 complete (5-7 workers successfully migrated)
- ‚úÖ Phase 2 complete (8-10 domain workers successfully migrated)
- ‚úÖ All build/deploy issues resolved
- ‚úÖ Explicit approval from project owner

**Core Services** (8 workers):
1. **gateway** - API gateway (1,349 LOC, 30+ tests)
2. **db** - Database RPC service (1,909 LOC, 16 tests)
3. **auth** - Authentication service (2,669 LOC, basic tests)
4. **schedule** - Cron jobs (1,925 LOC, 39 tests)
5. **webhooks** - External webhooks (2,114 LOC, 10 tests)
6. **email** - Transactional emails
7. **mcp** - Model Context Protocol server
8. **queue** - Message queue processing

## Migration Pattern

### Traditional Structure ‚Üí .mdx Transformation

**Original structure**:
```
workers/markdown/
‚îú‚îÄ‚îÄ worker.ts              # Implementation
‚îú‚îÄ‚îÄ wrangler.jsonc         # Config
‚îî‚îÄ‚îÄ package.json           # Dependencies
```

**Migrated structure**:
```
workers/
‚îú‚îÄ‚îÄ markdown.mdx           # All-in-one: config + code + docs
‚îî‚îÄ‚îÄ markdown/              # Generated by build script
    ‚îú‚îÄ‚îÄ wrangler.jsonc     # Extracted from frontmatter
    ‚îú‚îÄ‚îÄ src/
    ‚îÇ   ‚îî‚îÄ‚îÄ index.ts       # Extracted from code blocks
    ‚îî‚îÄ‚îÄ README.md          # Extracted from markdown
```

**Key Transformations**:

1. **Wrangler config** ‚Üí YAML frontmatter:
```mdx
---
$type: Worker
$id: markdown
name: markdown
main: src/index.ts
compatibility_date: "2025-07-08"
ai:
  binding: ai
routes:
  - pattern: markdown.fetch.do/*
    zone_name: fetch.do
---
```

2. **Implementation** ‚Üí TypeScript code block:
```mdx
## Implementation

\```typescript
import { env, WorkerEntrypoint } from 'cloudflare:workers'

export default class extends WorkerEntrypoint {
  async fetch(request: Request) {
    // Implementation...
  }
}
\```
```

3. **Documentation** ‚Üí Markdown sections:
```mdx
# Markdown Converter Worker

A Cloudflare Worker that fetches content from URLs and converts it to markdown.

## Features
- ‚úÖ URL Fetching
- ‚úÖ AI Conversion
...
```

## Benefits of .mdx Format

1. **Single Source of Truth** - Config, code, and docs in one file
2. **Zero Configuration** - Works immediately with mdxe
3. **Better Documentation** - Markdown sections explain purpose and usage
4. **Version Control Friendly** - One file = one worker
5. **Easy to Review** - See everything at once

## Testing

### Build Testing

```bash
# Build single .mdx worker
pnpm build-mdx markdown.mdx

# Build all .mdx workers
pnpm build-mdx:all

# Verify generated files
ls -la markdown/
```

### Deployment Testing

```bash
# Deploy to Cloudflare
cd markdown && wrangler deploy

# Test endpoint
curl https://markdown.fetch.do/example.com
```

## Lessons Learned

### Phase 1 Findings

1. **Build Script Issues**:
   - ‚ùå AI binding was not being extracted from frontmatter
   - ‚úÖ Fixed by adding `if (frontmatter.ai) config.ai = frontmatter.ai`
   - ‚ö†Ô∏è May need to add support for other bindings (Durable Objects, Analytics Engine, etc.)

2. **mdxe/wrangler Integration**:
   - ‚úÖ Build process works smoothly
   - ‚úÖ Generated files match traditional structure
   - ‚è≥ Deployment testing pending

3. **Documentation Value**:
   - ‚úÖ Combining docs with code improves maintainability
   - ‚úÖ Markdown sections make workers self-documenting
   - ‚úÖ Frontmatter provides clear overview of dependencies

## Next Steps

1. ‚úÖ Fix build script AI binding bug
2. ‚úÖ Create markdown.mdx and test build
3. ‚úÖ Document findings in MIGRATION-STATUS.md
4. ‚è≥ Test deployment of markdown worker
5. ‚è≥ Migrate ast.mdx (second test worker)
6. ‚è≥ Continue Phase 1 (remaining 5 workers)
7. ‚è≥ Update workers/CLAUDE.md with mdxe guidelines
8. ‚è≥ Commit changes

## Related Documentation

- [scripts/MIGRATION-STATUS.md](../scripts/MIGRATION-STATUS.md) - Scripts migration tracking
- [workers/CLAUDE.md](./CLAUDE.md) - Workers architecture and development guidelines
- [mdx/CLAUDE.md](../mdx/CLAUDE.md) - MDX ecosystem tooling
- [root CLAUDE.md](../CLAUDE.md) - Repository guidelines
